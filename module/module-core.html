<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>从一道绕人的难题开始，深究最新 Commonjs 实现机理 | 前端工程化打怪升级手册</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="开局一条狗，如何征服工程化">
    
    <link rel="preload" href="/front-end-engineering-handbook/assets/css/0.styles.4d68ed8c.css" as="style"><link rel="preload" href="/front-end-engineering-handbook/assets/js/app.a64d5fad.js" as="script"><link rel="preload" href="/front-end-engineering-handbook/assets/js/3.e17cbad9.js" as="script"><link rel="preload" href="/front-end-engineering-handbook/assets/js/1.45b034b9.js" as="script"><link rel="preload" href="/front-end-engineering-handbook/assets/js/9.a792d7fc.js" as="script"><link rel="prefetch" href="/front-end-engineering-handbook/assets/js/10.1c36d85b.js"><link rel="prefetch" href="/front-end-engineering-handbook/assets/js/11.59096481.js"><link rel="prefetch" href="/front-end-engineering-handbook/assets/js/12.2f6247a0.js"><link rel="prefetch" href="/front-end-engineering-handbook/assets/js/13.5b88f3c4.js"><link rel="prefetch" href="/front-end-engineering-handbook/assets/js/14.e80d8315.js"><link rel="prefetch" href="/front-end-engineering-handbook/assets/js/15.1a4bb958.js"><link rel="prefetch" href="/front-end-engineering-handbook/assets/js/16.2af617f6.js"><link rel="prefetch" href="/front-end-engineering-handbook/assets/js/4.396f0bf8.js"><link rel="prefetch" href="/front-end-engineering-handbook/assets/js/5.497640ae.js"><link rel="prefetch" href="/front-end-engineering-handbook/assets/js/6.735b6bed.js"><link rel="prefetch" href="/front-end-engineering-handbook/assets/js/7.3e29ab9c.js"><link rel="prefetch" href="/front-end-engineering-handbook/assets/js/8.adbd1ce3.js">
    <link rel="stylesheet" href="/front-end-engineering-handbook/assets/css/0.styles.4d68ed8c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-349e681a><div data-v-349e681a><div class="password-shadow password-wrapper-out" style="display:none;" data-v-b3e6ef50 data-v-349e681a data-v-349e681a><h3 class="title" data-v-b3e6ef50>前端工程化打怪升级手册</h3> <p class="description" data-v-b3e6ef50>开局一条狗，如何征服工程化</p> <label id="box" class="inputBox" data-v-b3e6ef50><input type="password" value="" data-v-b3e6ef50> <span data-v-b3e6ef50>Konck! Knock!</span> <button data-v-b3e6ef50>OK</button></label> <div class="footer" data-v-b3e6ef50><span data-v-b3e6ef50><i class="iconfont reco-theme" data-v-b3e6ef50></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-b3e6ef50>vuePress-theme-reco</a></span> <span data-v-b3e6ef50><i class="iconfont reco-copyright" data-v-b3e6ef50></i> <a data-v-b3e6ef50><!---->
          
        <!---->
        2023
      </a></span></div></div> <div class="hide" data-v-349e681a><header class="navbar" data-v-349e681a><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/front-end-engineering-handbook/" class="home-link router-link-active"><!----> <span class="site-name">前端工程化打怪升级手册</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/front-end-engineering-handbook/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      战场小包
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/zcxiaobao" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://juejin.cn/user/4424090519078430" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-349e681a></div> <aside class="sidebar" data-v-349e681a><div class="personal-info-wrapper" data-v-1bfe3fa5 data-v-349e681a><!----> <!----> <div class="num" data-v-1bfe3fa5><div data-v-1bfe3fa5><h3 data-v-1bfe3fa5>7</h3> <h6 data-v-1bfe3fa5>文章</h6></div> <div data-v-1bfe3fa5><h3 data-v-1bfe3fa5>0</h3> <h6 data-v-1bfe3fa5>标签</h6></div></div> <ul class="social-links" data-v-1bfe3fa5></ul> <hr data-v-1bfe3fa5></div> <nav class="nav-links"><div class="nav-item"><a href="/front-end-engineering-handbook/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      战场小包
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/zcxiaobao" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://juejin.cn/user/4424090519078430" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/front-end-engineering-handbook/module/origin" class="sidebar-heading clickable open"><span>基础部分</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/front-end-engineering-handbook/module/origin.html" class="sidebar-link">模块化前世今生</a></li><li><a href="/front-end-engineering-handbook/module/esm.html" class="sidebar-link">前端模块化未来探索</a></li><li><a href="/front-end-engineering-handbook/module/pure-esm.html" class="sidebar-link">Pure ESM &amp; Dual Packages</a></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-b3e6ef50 data-v-349e681a><h3 class="title" data-v-b3e6ef50>从一道绕人的难题开始，深究最新 Commonjs 实现机理</h3> <!----> <label id="box" class="inputBox" data-v-b3e6ef50><input type="password" value="" data-v-b3e6ef50> <span data-v-b3e6ef50>Konck! Knock!</span> <button data-v-b3e6ef50>OK</button></label> <div class="footer" data-v-b3e6ef50><span data-v-b3e6ef50><i class="iconfont reco-theme" data-v-b3e6ef50></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-b3e6ef50>vuePress-theme-reco</a></span> <span data-v-b3e6ef50><i class="iconfont reco-copyright" data-v-b3e6ef50></i> <a data-v-b3e6ef50><!---->
          
        <!---->
        2023
      </a></span></div></div> <div data-v-349e681a><div data-v-349e681a><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">从一道绕人的难题开始，深究最新 Commonjs 实现机理</h1> <div data-v-0b291498><i class="iconfont reco-account" data-v-0b291498><span data-v-0b291498>战场小包</span></i> <i class="iconfont reco-date" data-v-0b291498><span data-v-0b291498>2021/3/30</span></i> <!----> <!----></div></div> <div class="theme-reco-content content__default"><h2 id="写在前面"><a href="#写在前面" class="header-anchor">#</a> 写在前面</h2> <p>Commomjs 和 ESM 是目前 JavaScript 中最常用的两种模块化规范，深入了解其核心机理可以有效加深我们对模块化的理解，话不多说，先看题目。</p> <h3 id="commonjs-案例"><a href="#commonjs-案例" class="header-anchor">#</a> Commonjs 案例</h3> <ul><li>a.js 文件</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'a.js 开始执行'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
exports<span class="token punctuation">.</span>done <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token punctuation">{</span><span class="token literal-property property">done</span><span class="token operator">:</span> bDone<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./b.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'in a，b.done ='</span><span class="token punctuation">,</span> bDone<span class="token punctuation">)</span><span class="token punctuation">;</span>
exports<span class="token punctuation">.</span>done <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'a.js 执行完毕'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>b.js 文件</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'b.js 开始执行'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
exports<span class="token punctuation">.</span>done <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token punctuation">{</span><span class="token literal-property property">done</span><span class="token operator">:</span> aDone<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./a.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'in b，a.done ='</span><span class="token punctuation">,</span> aDone<span class="token punctuation">)</span><span class="token punctuation">;</span>
exports<span class="token punctuation">.</span>done <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'b.js 执行完毕'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>index.js 文件</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./a'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> b <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./b'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span>
</code></pre></div><p>若此时执行 index.js 文件，控制会依次输出什么那？</p> <h3 id="esm-案例"><a href="#esm-案例" class="header-anchor">#</a> ESM 案例</h3> <ul><li>a.js 文件</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'a.js 开始执行'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">var</span> done <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> done <span class="token keyword">as</span> bDone <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./b.js'</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'in a, b.done ='</span><span class="token punctuation">,</span> bDone<span class="token punctuation">)</span><span class="token punctuation">;</span>
done <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'a.js 执行完毕'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>b.js 文件</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'b.js 开始执行'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">let</span> done <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> done <span class="token keyword">as</span> aDone <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./a.js'</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'in b, a.done ='</span><span class="token punctuation">,</span> aDone<span class="token punctuation">)</span><span class="token punctuation">;</span>
done <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'b.js 执行完毕'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>index.js 文件</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> a <span class="token keyword">from</span> <span class="token string">&quot;./a.js&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> b <span class="token keyword">from</span> <span class="token string">&quot;./b.js&quot;</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>若此时执行 index.js 文件，控制台又会输出什么那？</p> <blockquote><p>Tips: 该题此时会抛出错误，你能解释错误原因并修改程序吗？</p></blockquote> <h3 id="案例小结"><a href="#案例小结" class="header-anchor">#</a> 案例小结</h3> <p>这里先不揭晓答案，咱们先来分析一下这两段代码的核心问题。两段代码本质是类似的，但是使用的规范不同，因此两者实现和结果都会有略微差异。</p> <p>案例情形是这样的：</p> <ul><li>循环依赖: a.js 依赖于 b.js，b.js则又依赖于 a.js，两者构成了一个简单的循环依赖。</li> <li>重复加载: index.js 中分别导入了 a.js 与 b.js，而a，b两模块间存在循环依赖，再导入会造成重复加载问题。</li></ul> <p>也就是说，上面的案例共同的核心在于循环依赖和重复加载，这两者都是项目开发中不可避免地痛点问题。</p> <p>在大型项目中，模块之间的依赖关系可能非常复杂，就像是一张错综复杂的交错网络。有时候，两个或多个模块之间会形成相互依赖的关系，就像是朋友间互相需要对方的帮助。但是，如果两个人都需要对方的帮助，而又没有帮助的先后顺序，就会形成僵局，直到最终变得越来越糟糕。这就是循环依赖的危险所在，如果处理不当，程序就会不断递归加载，直到崩溃。</p> <p>重复加载也是类似的情形，多个模块可能会依赖同一个模块，如果每个模块都去加载和解析同一个模块，会浪费大量的时间和计算资源，同时也会增加代码的体积和维护成本。这就好比每次去超市买东西时，只是单纯的购物，并不会记住商品的大致分布，这就导致每次去超市都像无头苍蝇一样从头开始找，不仅浪费时间，还会给我们的生活带来很多不必要的麻烦。</p> <p>下面我们就一起来看看Commonjs 和 ESM 内部是如何处理循环依赖和重复加载的？</p> <h2 id="commonjs-机理"><a href="#commonjs-机理" class="header-anchor">#</a> Commonjs 机理</h2> <h3 id="前置知识"><a href="#前置知识" class="header-anchor">#</a> 前置知识</h3> <p>Commonjs 规范规定，一个文件即为一个模块，如何找到这个文件，又该如何加载这个文件成为 Commonjs 规范的核心问题。</p> <p>根据这两个问题，Nodejs 实现了自身的 Commonjs 规范，模块引入过程可以分为三步</p> <ul><li>模块分析</li> <li>模块寻址</li> <li>编译执行</li></ul> <p>Nodejs中将模块，根据加载标识符的不同，可以将模块分为三类</p> <ul><li>文件模块: 以 ./ 或者 ../ 等相对路径前缀开头标识，或者以 / 等绝对路径开头表示</li> <li>内置模块: 官方内置的模块，例如 fs、path 等可以直接使用的模块</li> <li>第三方模块: 非路径格式也非核心模块</li></ul> <p>内置模块内嵌在 Nodejs 源码中，Nodejs 启动时会直接被加载到内存中，加载时无需进行模块寻址，加载速度快。</p> <p>文件模块和第三方模块则需要运行时进行加载，需要执行三步走步骤，加载速度相对较慢。</p> <p>模块类型不同，Commonjs的加载规则也略有不同，下面一起来调试 Nodejs 源码，理解一下Commonjs是如何加载不同类型模块的。</p> <h3 id="环境配置"><a href="#环境配置" class="header-anchor">#</a> 环境配置</h3> <blockquote><p>最新版本Nodejs v</p></blockquote> <p>首先借助 VSCode 创建一个launch.json，同时注释掉 skipFiles 的内容，注意不要直接删除，VSCode内部会有默认配置，删除不生效。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0.2.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;configurations&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;request&quot;</span><span class="token operator">:</span> <span class="token string">&quot;launch&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;启动程序&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;skipFiles&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token comment">// &quot;&lt;node_internals&gt;/**&quot;</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">&quot;program&quot;</span><span class="token operator">:</span> <span class="token string">&quot;${workspaceFolder}\\code\\4.module-core\\commonjs-load\\load.js&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后建立一个 commomnjs-load 文件夹，里面共两个 js 文件</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// module.js</span>
module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'zcxiaobao'</span><span class="token punctuation">;</span>

<span class="token comment">// load.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./module'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// debugger</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>点击调试，开始源码之旅吧。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Module</span><span class="token punctuation">(</span>id <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">,</span> parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>path <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 在模块中使用的 modules.export = Module 本身，而 exports 是Module的一个属性</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  moduleParentCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">updateChildren</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>filename <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="模块分析"><a href="#模块分析" class="header-anchor">#</a> 模块分析</h3> <p>首先会调用 makeRequireFunction 函数中的 require 方法，传递当前模块路径 <code>./module</code>。</p> <p><img src="/front-end-engineering-handbook/assets/img/makeRequireFunc.b1bc60cf.png" alt=""></p> <p>然后我们就进入 Module 构造函数原型方法 require 中，继续调试进入 Module._load 方法</p> <p><img src="/front-end-engineering-handbook/assets/img/require.46721b59.png" alt=""></p> <p>Module._load 方法真的是 Commonjs 实现过程中少有的良心源码了，附带了详细的注释，通过注释，我们基本可以了解主要逻辑：</p> <ul><li>首先检查缓存中是否存在所请求的文件，如果缓存中存在，则返回其 exports 对象；</li> <li>其次若为内置模块，则调用 <code>BuiltinModule.prototype.compileForPublicLoader()</code> 并返回 exports；</li> <li>否则，为该文件创建一个新模块并保存到缓存中，加载文件内容，返回 exports 对象。</li></ul> <p>Module._load 函数内容较长，这里咱们把它拆分一下。</p> <p>nodejs在后期演变过程中，扩展了内置模块的引用方式，允许以 <code>node:</code> 为前缀，加载内置模块。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// node 高版本新提出，可以通过 node:: 前缀加载用户侧可加载的内置模块</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">StringPrototypeStartsWith</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'node:'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Slice 'node:' prefix</span>
  <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token function">StringPrototypeSlice</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> module <span class="token operator">=</span> <span class="token function">loadBuiltinModule</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>module<span class="token operator">?.</span>canBeRequiredByUsers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ERR_UNKNOWN_BUILTIN_MODULE</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在 Nodejs 中，模块加载存在缓存机制，对同一文件的重复加载一律返回缓存，由于文件绝对路径不会发生重复，以此作为缓存的key。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 获取文件的绝对路径，作为缓存 key；后续会详解该方法</span>
<span class="token keyword">const</span> filename <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">_resolveFilename</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> isMain<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 获取缓存</span>
<span class="token keyword">const</span> cachedModule <span class="token operator">=</span> Module<span class="token punctuation">.</span>_cache<span class="token punctuation">[</span>filename<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// 缓存中存在该模块</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>cachedModule <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">updateChildren</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> cachedModule<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果要加载的模块缓存已经存在，但是并没有完全加载好（循环依赖关键）</span>
    <span class="token comment">// 后面会返回来讲这个地方</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cachedModule<span class="token punctuation">.</span>loaded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> parseCachedModule <span class="token operator">=</span> cjsParseCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cachedModule<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>parseCachedModule <span class="token operator">||</span> parseCachedModule<span class="token punctuation">.</span>loaded<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">getExportsForCircularRequire</span><span class="token punctuation">(</span>cachedModule<span class="token punctuation">)</span><span class="token punctuation">;</span>
      parseCachedModule<span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果已经加载完毕，直接返回 exports 对象即可</span>
      <span class="token keyword">return</span> cachedModule<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>检查完缓存后，进行内置模块判断。Nodejs 源码中自带一份内置模块 map，只需去map中搜索一番，即可得出是否为内置模块，loadBuiltinModule 的逻辑还是比较简单的。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 检测是否为内置模块</span>
<span class="token keyword">const</span> mod <span class="token operator">=</span> <span class="token function">loadBuiltinModule</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>mod<span class="token operator">?.</span>canBeRequiredByUsers <span class="token operator">&amp;&amp;</span>
    BuiltinModule<span class="token punctuation">.</span><span class="token function">canBeRequiredWithoutScheme</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> mod<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">loadBuiltinModule</span><span class="token punctuation">(</span><span class="token parameter">filename<span class="token punctuation">,</span> request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> mod <span class="token operator">=</span> BuiltinModule<span class="token punctuation">.</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>mod<span class="token operator">?.</span>canBeRequiredByUsers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'load built-in module %s'</span><span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// compileForPublicLoader() throws if mod.canBeRequiredByUsers is false:</span>
    mod<span class="token punctuation">.</span><span class="token function">compileForPublicLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> mod<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>未命中缓存，也没匹配到原生模块，因此创建一个新的 Module 实例，绝对路径为 key，存储到缓存中</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> module <span class="token operator">=</span> cachedModule <span class="token operator">||</span> <span class="token keyword">new</span> <span class="token class-name">Module</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
Module<span class="token punctuation">.</span>_cache<span class="token punctuation">[</span>filename<span class="token punctuation">]</span> <span class="token operator">=</span> module<span class="token punctuation">;</span>
</code></pre></div><p>代码到这里，我们已经获取模块文件地址及模块实例，接下来就需要将模块文件的内容加载进来。</p> <p>文件的加载存在失败的可能，<code>Module._cache[filename] = module</code> 未加载便写入缓存存在一定的安全隐患，因此在这里官方添加了一个锁 threw。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> threw <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token comment">// 加载模块</span>
  module<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
  threw <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果加载失败，删除缓存</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>threw<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">delete</span> Module<span class="token punctuation">.</span>_cache<span class="token punctuation">[</span>filename<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports <span class="token operator">&amp;&amp;</span>
              <span class="token operator">!</span><span class="token function">isProxy</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
              <span class="token function">ObjectGetPrototypeOf</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">)</span> <span class="token operator">===</span>
                CircularRequirePrototypeWarningProxy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ObjectSetPrototypeOf</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> ObjectPrototype<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 返回 module.exports 对象</span>
<span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
</code></pre></div><p>模块分析的部分到这里就结束了，这里我们画图小结一下整体流程:</p> <p><img src="/front-end-engineering-handbook/assets/img/Module._load.e4bad248.png" alt=""></p> <p>在调试代码之前，我们提出几个问题，带着问题来更好的理解源码流程</p> <ol><li>Commonjs 规范中规定，一个文件为一个模块，所以说无论是那种类型的模块，最终都需要落实到某一文件上，那么这个文件是如何<strong>寻址</strong>到的那？</li> <li>Commonjs 通过何种方式构建了模块内部变量的作用域，来实现变量封装、避免全局污染等问题？</li> <li></li></ol> <p>然后下面咱们就开始一起进行调试，由于源码内容相对还是比较复杂，因此在这个调试过程，我会尽可能地简化代码，最快速度的让你抓住核心内容。</p> <p>寻址过程中，如果遇到 node_modules ，除非找到对应包，否则不会停止，会一直向上</p> <p>流程</p> <p>mod.require --- Module.prototype.require
Module._load
+ StringPrototypeStartsWith(request, 'node:')
+ Module._resolveFilename
+ Module._resolveLookupPaths
+ Module._cache
+ Module._cache[filename] = module;
+ Module.load(filename);
+ const extension = findLongestRegisteredExtension(filename)
+ Module._extensions[extension](this, filename);
+ Module._extensions['.js']
+ content = fs.readFileSync(filename, 'utf8');
+ module._compile
+ const compiledWrapper = wrapSafe(filename, content, this);
+ internalCompileFunction --&gt; function
+ ReflectApply
+ return module.exports;</p> <h3 id="模块寻址"><a href="#模块寻址" class="header-anchor">#</a> 模块寻址</h3> <p>模块分析的核心任务便是<strong>区分开加载的模块类型</strong>，模块类型不同，加载方式有所不同。对于内置模块，我们直接返回内置的 exports 即可，而对于文件模块和第三方模块，就没有这么简单了。</p> <p>Commonjs 规范规定一个文件即为一个模块，模块的加载本质上是加载对应模块文件，如何找到这个关键是模块能否成功加载的关键。</p> <p>日常开发中我们通常可以这样使用:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 加载文件模块</span>
<span class="token keyword">const</span> moduleA <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./moduleA'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> moduleB <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./moduleB.js'</span><span class="token punctuation">)</span>
<span class="token comment">// 加载第三方模块</span>
<span class="token keyword">const</span> vue <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue'</span><span class="token punctuation">)</span>
</code></pre></div><p>可以发现，我们使用时，文件模块可以带后缀名，同样也可以不带后缀名，第三方模块的加载直接使用对应模块名即可，这是如何实现的呐？</p> <p>在 Nodejs 早期版本中，寻址逻辑大致是这样的</p> <ul><li>若是以 <code>./</code> 或者 <code>../</code> 等相对路径为前缀，则认为是相对路径模式文件模块，以当前模块文件为源头来寻址</li> <li>否则，该模块为内置模块或者第三方模块
<ul><li>检测该模块是否为用户侧可加载的内置模块，若是，直接使用</li> <li>否则从当前文件目录开始，在寻找 node_modules 中寻找对应模块</li> <li>如果没找到，继续去上级目录下的 node_modules 中寻找</li> <li>重复上面步骤，直至根目录</li></ul></li></ul> <p>现在 Nodejs 的寻址进一步完善了早期的寻址逻辑。在 <code>_resolveFilename</code> 除加入断点，进入到该函数中。</p> <p>首先同样添加了对 node: 前缀内置模块的检测，这部分类似于 Module._load 中。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token punctuation">(</span>
      <span class="token function">StringPrototypeStartsWith</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'node:'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      BuiltinModule<span class="token punctuation">.</span><span class="token function">canBeRequiredByUsers</span><span class="token punctuation">(</span><span class="token function">StringPrototypeSlice</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>
      BuiltinModule<span class="token punctuation">.</span><span class="token function">canBeRequiredByUsers</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      BuiltinModule<span class="token punctuation">.</span><span class="token function">canBeRequiredWithoutScheme</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> request<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后是一段<a href="">自定义基路径寻址</a>逻辑，require 加载模块过程并不会用到，是给 require.resolve 函数用的，这里了解一下就可以。</p> <div class="language-js extra-class"><pre class="language-js"><code>
</code></pre></div><p>接下来就到了模块寻址的关键之处，<code>_resolveLookupPaths()</code> 函数，该函数负责生成模块的基路径数组，进入到该函数中看一下详情。</p> <div class="language-js extra-class"><pre class="language-js"><code>Module<span class="token punctuation">.</span><span class="token function-variable function">_resolveLookupPaths</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 检测是否为内置模块</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>
    <span class="token function">StringPrototypeStartsWith</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'node:'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    BuiltinModule<span class="token punctuation">.</span><span class="token function">canBeRequiredByUsers</span><span class="token punctuation">(</span><span class="token function">StringPrototypeSlice</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>
    BuiltinModule<span class="token punctuation">.</span><span class="token function">canBeRequiredByUsers</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    BuiltinModule<span class="token punctuation">.</span><span class="token function">canBeRequiredWithoutScheme</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'looking for %j in []'</span><span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 检测是否为第三方模块</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">StringPrototypeCharAt</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">'.'</span> <span class="token operator">||</span>
      <span class="token punctuation">(</span>request<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span>
      <span class="token function">StringPrototypeCharAt</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">'.'</span> <span class="token operator">&amp;&amp;</span>
      <span class="token function">StringPrototypeCharAt</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">'/'</span> <span class="token operator">&amp;&amp;</span>
      <span class="token punctuation">(</span><span class="token operator">!</span>isWindows <span class="token operator">||</span> <span class="token function">StringPrototypeCharAt</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">'\\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">let</span> paths<span class="token punctuation">;</span>
    <span class="token comment">// parent.paths 存储了模块的一系列父路径</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parent<span class="token operator">?.</span>paths<span class="token operator">?.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      paths <span class="token operator">=</span> <span class="token function">ArrayPrototypeSlice</span><span class="token punctuation">(</span>modulePaths<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">ArrayPrototypeUnshiftApply</span><span class="token punctuation">(</span>paths<span class="token punctuation">,</span> parent<span class="token punctuation">.</span>paths<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      paths <span class="token operator">=</span> modulePaths<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> paths<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> paths <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 文件模块，基路径为当前模块目录地址</span>
  <span class="token keyword">const</span> parentDir <span class="token operator">=</span> <span class="token punctuation">[</span>path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>parent<span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> parentDir<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>通过代码可以发现，基路径数组的逻辑类似于模块分析，根据模块类型不同，基路径有所不同</p> <ul><li>如果为内置模块，无需基路径，因此返回 null</li> <li>如果不是以相对路径开头，代表为第三方模块
<ul><li>此时基路径数组由 [parent.paths, modulePaths] 构成
<ul><li>modulePaths 存储了HOME 环境变量中 <code>.node_modules</code>、<code>.node_libararies</code>及 Global 安装目录等</li> <li>parent.paths 为从当前路径开始的每一级目录加上 <code>node_modules</code></li></ul></li> <li>也就是说，第三方模块的基路径数组为从当前目录开始，直至根目录，依次寻找 node_modules 目录是否存在对应模块；全部失败后再去 node 的默认存储寻找</li></ul></li> <li>否则，代表为文件模块，基路径为当前模块的目录地址</li></ul> <p><img src="/front-end-engineering-handbook/assets/img/resolveLookupPaths.79ae994a.png" alt=""></p> <p>获取基路径数组后，寻址逻辑并没有结束，例如开发时我们写了两个文件模块 <code>a.js</code> 和 <code>a.json</code>，通过 <code>require('./a')</code> 引入，基路径数组通过 <code>'./a'</code> 来获取，无法区分后缀名，因此还需要进一步完善模块的详细路径，也就是 <code>_findPath</code> 函数，该函数接收三个参数，分别是待加载模块，基路径数组，是否为主入口模块。</p> <p>这个函数处理的情况还是有点多的，咱们一步一步解剖一下:</p> <p>Step1: 判断 request 是否为绝对路径，若是，说明它已经包含了基路径，将基路径置为空字符串</p> <div class="language-js extra-class"><pre class="language-js"><code>Module<span class="token punctuation">.</span><span class="token function-variable function">_findPath</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> paths<span class="token punctuation">,</span> isMain</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> absoluteRequest <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">isAbsolute</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>absoluteRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    paths <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">''</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>paths <span class="token operator">||</span> paths<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>


  <span class="token comment">// 尝试每个基路径</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> paths<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 检车对应基路径是否存在</span>
    <span class="token keyword">const</span> curPath <span class="token operator">=</span> paths<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>insidePath <span class="token operator">&amp;&amp;</span> curPath <span class="token operator">&amp;&amp;</span> <span class="token function">_stat</span><span class="token punctuation">(</span>curPath<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>absoluteRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> exportsResolved <span class="token operator">=</span> <span class="token function">resolveExports</span><span class="token punctuation">(</span>curPath<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>exportsResolved<span class="token punctuation">)</span>
        <span class="token keyword">return</span> exportsResolved<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 基路径 + request 组装成新路径</span>
    <span class="token keyword">const</span> basePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>curPath<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> filename<span class="token punctuation">;</span>
    <span class="token comment">// 检测新路径的状态: 存在与否，若存在，是文件还是目录</span>
    <span class="token keyword">const</span> rc <span class="token operator">=</span> <span class="token function">_stat</span><span class="token punctuation">(</span>basePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>trailingSlash<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 代表为文件</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isMain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 符号链接</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>preserveSymlinks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            filename <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>basePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            filename <span class="token operator">=</span> <span class="token function">toRealPath</span><span class="token punctuation">(</span>basePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>preserveSymlinksMain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          filename <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>basePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          filename <span class="token operator">=</span> <span class="token function">toRealPath</span><span class="token punctuation">(</span>basePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>filename<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取nodejs 支持的后缀名</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>exts <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span>
          exts <span class="token operator">=</span> <span class="token function">ObjectKeys</span><span class="token punctuation">(</span>Module<span class="token punctuation">.</span>_extensions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 挨着后缀名进行尝试</span>
        filename <span class="token operator">=</span> <span class="token function">tryExtensions</span><span class="token punctuation">(</span>basePath<span class="token punctuation">,</span> exts<span class="token punctuation">,</span> isMain<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>filename <span class="token operator">&amp;&amp;</span> rc <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// Directory.</span>
      <span class="token comment">// try it with each of the extensions at &quot;index&quot;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>exts <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span>
        exts <span class="token operator">=</span> <span class="token function">ObjectKeys</span><span class="token punctuation">(</span>Module<span class="token punctuation">.</span>_extensions<span class="token punctuation">)</span><span class="token punctuation">;</span>
      filename <span class="token operator">=</span> <span class="token function">tryPackage</span><span class="token punctuation">(</span>basePath<span class="token punctuation">,</span> exts<span class="token punctuation">,</span> isMain<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>filename<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Module<span class="token punctuation">.</span>_pathCache<span class="token punctuation">[</span>cacheKey<span class="token punctuation">]</span> <span class="token operator">=</span> filename<span class="token punctuation">;</span>
      <span class="token keyword">return</span> filename<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> extensions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">''</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>exts <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">ArrayPrototypePushApply</span><span class="token punctuation">(</span>extensions<span class="token punctuation">,</span> exts<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">reportModuleNotFoundToWatchMode</span><span class="token punctuation">(</span>basePath<span class="token punctuation">,</span> extensions<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>Step2: 从基路径数组 paths 中获取一个基路径，检测该路径是否有效。若有效，用基路径加上 request 组成一个新路径 basePath</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> paths<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> curPath <span class="token operator">=</span> paths<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// _stat 是 nodejs 内置的检测文件或者路径存在与否的方法</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>insidePath <span class="token operator">&amp;&amp;</span> curPath <span class="token operator">&amp;&amp;</span> <span class="token function">_stat</span><span class="token punctuation">(</span>curPath<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> basePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>curPath<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其实源码在这里还有对高版本 Nodejs exports 字段的兼容，[exports]详情可以参考文档，如果 package.json 中配置了 exports 字段，这里会获取到对应路径信息，直接返回即可。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>absoluteRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> exportsResolved <span class="token operator">=</span> <span class="token function">resolveExports</span><span class="token punctuation">(</span>curPath<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>exportsResolved<span class="token punctuation">)</span>
    <span class="token keyword">return</span> exportsResolved<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Step3: 通过检查新路径最后一位是否为 <code>/</code>，来区分文件与目录</p> <ul><li>若为文件，首先检测该文件是否存在，存在返回路径 filename</li> <li>若不存在，试图添加后缀名在尝试文件是否存在，若任一存在，返回 filename</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 尝试每个基路径</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> paths<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 检车对应基路径是否存在</span>
  <span class="token keyword">const</span> curPath <span class="token operator">=</span> paths<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>insidePath <span class="token operator">&amp;&amp;</span> curPath <span class="token operator">&amp;&amp;</span> <span class="token function">_stat</span><span class="token punctuation">(</span>curPath<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>absoluteRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> exportsResolved <span class="token operator">=</span> <span class="token function">resolveExports</span><span class="token punctuation">(</span>curPath<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>exportsResolved<span class="token punctuation">)</span>
      <span class="token keyword">return</span> exportsResolved<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 基路径 + request 组装成新路径</span>
  <span class="token keyword">const</span> basePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>curPath<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> filename<span class="token punctuation">;</span>
  <span class="token comment">// 检测新路径的状态: 存在与否，若存在，是文件还是目录</span>
  <span class="token keyword">const</span> rc <span class="token operator">=</span> <span class="token function">_stat</span><span class="token punctuation">(</span>basePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>trailingSlash<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 代表为文件</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isMain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 符号链接</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>preserveSymlinks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          filename <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>basePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          filename <span class="token operator">=</span> <span class="token function">toRealPath</span><span class="token punctuation">(</span>basePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>preserveSymlinksMain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        filename <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>basePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        filename <span class="token operator">=</span> <span class="token function">toRealPath</span><span class="token punctuation">(</span>basePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>filename<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 获取nodejs 支持的后缀名</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>exts <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span>
        exts <span class="token operator">=</span> <span class="token function">ObjectKeys</span><span class="token punctuation">(</span>Module<span class="token punctuation">.</span>_extensions<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 挨着后缀名进行尝试</span>
      filename <span class="token operator">=</span> <span class="token function">tryExtensions</span><span class="token punctuation">(</span>basePath<span class="token punctuation">,</span> exts<span class="token punctuation">,</span> isMain<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>Module._extensions</code> 是 Nodejs 模块化规范中一个很核心的实现理念，我们知道 Nodejs 可以处理三类文件: <code>.js</code>，<code>.json</code>，<code>.node</code>，此外还支持其他类型文件的扩展，各类文件的处理方法不尽相同，Nodejs 于是就定义了 <code>Module._extensions</code> 对象，键为后缀名，值为对应处理函数，也就是如下形式</p> <div class="language-js extra-class"><pre class="language-js"><code>Module<span class="token punctuation">.</span>_extensions <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string">'.js'</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">/* JsFunc */</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">'json'</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">/* JsonFunc */</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">'.node'</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">/* NodeFunc */</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过 <code>ObjectKeys(Module._extensions)</code> 可以获取到键值，然后借助 <code>tryExtensions</code> 依次就行尝试，尝试的顺序默认按照键值的顺序，也就是 <code>'.js' -&gt; '.json' -&gt; '.node'</code>，这也就解释了当同时存在 index.js 和 index.json 时，默认都是先加载 index.js。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">tryExtensions</span><span class="token punctuation">(</span><span class="token parameter">p<span class="token punctuation">,</span> exts<span class="token punctuation">,</span> isMain</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> exts<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> filename <span class="token operator">=</span> <span class="token function">tryFile</span><span class="token punctuation">(</span>p <span class="token operator">+</span> exts<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> isMain<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>filename<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> filename<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Step4: 若新路径为目录，则:</p> <ul><li>若该目录下存在 package.json，尝试使用 main 字段，进行寻址</li> <li>若寻址失败，在新路径基础上尝试添加 <code>index+后缀名</code></li></ul> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>filename <span class="token operator">&amp;&amp;</span> rc <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// Directory.</span>
  <span class="token comment">// try it with each of the extensions at &quot;index&quot;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>exts <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span>
    exts <span class="token operator">=</span> <span class="token function">ObjectKeys</span><span class="token punctuation">(</span>Module<span class="token punctuation">.</span>_extensions<span class="token punctuation">)</span><span class="token punctuation">;</span>
  filename <span class="token operator">=</span> <span class="token function">tryPackage</span><span class="token punctuation">(</span>basePath<span class="token punctuation">,</span> exts<span class="token punctuation">,</span> isMain<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">tryPackage</span><span class="token punctuation">(</span><span class="token parameter">requestPath<span class="token punctuation">,</span> exts<span class="token punctuation">,</span> isMain<span class="token punctuation">,</span> originalPath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> pkg <span class="token operator">=</span> <span class="token function">_readPackage</span><span class="token punctuation">(</span>requestPath<span class="token punctuation">)</span><span class="token operator">?.</span>main<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pkg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">tryExtensions</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>requestPath<span class="token punctuation">,</span> <span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exts<span class="token punctuation">,</span> isMain<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> filename <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>requestPath<span class="token punctuation">,</span> pkg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> actual <span class="token operator">=</span> <span class="token function">tryFile</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> isMain<span class="token punctuation">)</span> <span class="token operator">||</span>
    <span class="token function">tryExtensions</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> exts<span class="token punctuation">,</span> isMain<span class="token punctuation">)</span> <span class="token operator">||</span>
    <span class="token function">tryExtensions</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exts<span class="token punctuation">,</span> isMain<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 精简部分不关键代码</span>
  <span class="token keyword">return</span> actual<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Step5: 如果还没有寻址成功，则失败。</p> <h4 id="模块寻址小结"><a href="#模块寻址小结" class="header-anchor">#</a> 模块寻址小结</h4> <h3 id="核心实现"><a href="#核心实现" class="header-anchor">#</a> 核心实现</h3> <h3 id="文件模块加载"><a href="#文件模块加载" class="header-anchor">#</a> 文件模块加载</h3> <h2 id="esm-机理"><a href="#esm-机理" class="header-anchor">#</a> ESM 机理</h2></div></section> <footer class="page-edit"><!----> <!----></footer> <!----> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-3b069fde data-v-349e681a><li class="level-2" data-v-3b069fde><a href="/front-end-engineering-handbook/module/module-core.html#写在前面" class="sidebar-link reco-side-写在前面" data-v-3b069fde>写在前面</a></li><li class="level-3" data-v-3b069fde><a href="/front-end-engineering-handbook/module/module-core.html#commonjs-案例" class="sidebar-link reco-side-commonjs-案例" data-v-3b069fde>Commonjs 案例</a></li><li class="level-3" data-v-3b069fde><a href="/front-end-engineering-handbook/module/module-core.html#esm-案例" class="sidebar-link reco-side-esm-案例" data-v-3b069fde>ESM 案例</a></li><li class="level-3" data-v-3b069fde><a href="/front-end-engineering-handbook/module/module-core.html#案例小结" class="sidebar-link reco-side-案例小结" data-v-3b069fde>案例小结</a></li><li class="level-2" data-v-3b069fde><a href="/front-end-engineering-handbook/module/module-core.html#commonjs-机理" class="sidebar-link reco-side-commonjs-机理" data-v-3b069fde>Commonjs 机理</a></li><li class="level-3" data-v-3b069fde><a href="/front-end-engineering-handbook/module/module-core.html#前置知识" class="sidebar-link reco-side-前置知识" data-v-3b069fde>前置知识</a></li><li class="level-3" data-v-3b069fde><a href="/front-end-engineering-handbook/module/module-core.html#环境配置" class="sidebar-link reco-side-环境配置" data-v-3b069fde>环境配置</a></li><li class="level-3" data-v-3b069fde><a href="/front-end-engineering-handbook/module/module-core.html#模块分析" class="sidebar-link reco-side-模块分析" data-v-3b069fde>模块分析</a></li><li class="level-3" data-v-3b069fde><a href="/front-end-engineering-handbook/module/module-core.html#模块寻址" class="sidebar-link reco-side-模块寻址" data-v-3b069fde>模块寻址</a></li><li class="level-3" data-v-3b069fde><a href="/front-end-engineering-handbook/module/module-core.html#核心实现" class="sidebar-link reco-side-核心实现" data-v-3b069fde>核心实现</a></li><li class="level-3" data-v-3b069fde><a href="/front-end-engineering-handbook/module/module-core.html#文件模块加载" class="sidebar-link reco-side-文件模块加载" data-v-3b069fde>文件模块加载</a></li><li class="level-2" data-v-3b069fde><a href="/front-end-engineering-handbook/module/module-core.html#esm-机理" class="sidebar-link reco-side-esm-机理" data-v-3b069fde>ESM 机理</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-2a01419c data-v-2a01419c><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-2a01419c><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-2a01419c></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-2a01419c></path></svg></div></div></div>
    <script src="/front-end-engineering-handbook/assets/js/app.a64d5fad.js" defer></script><script src="/front-end-engineering-handbook/assets/js/3.e17cbad9.js" defer></script><script src="/front-end-engineering-handbook/assets/js/1.45b034b9.js" defer></script><script src="/front-end-engineering-handbook/assets/js/9.a792d7fc.js" defer></script>
  </body>
</html>
